name: CI/CD Pipeline
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # ‚ö†Ô∏è REMPLACEZ CES VALEURS PAR LES V√îTRES ‚ö†Ô∏è
  AZURE_RESOURCE_GROUP: rg-nlp-deployment
  ACR_NAME: mlopsashash          # Le nom de VOTRE ACR (√©tape 5.1)
  CONTAINER_APP_NAME: bank-churn    # Le nom de VOTRE Container App (√©tape 5.2)
  STREAMLIT_APP_NAME: bank-churn-dashboard  # Nom de l'app Streamlit
  IMAGE_NAME: bank-churn-api
  STREAMLIT_IMAGE_NAME: bank-churn-streamlit
  LOCATION: swedencentral
  CONTAINER_ENV_NAME: env-nlp     # Environnement existant

jobs:
  # ============================================================
  # JOB 1: TESTS
  # ============================================================
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run linting (optional)
        continue-on-error: true
        run: |
          pip install flake8
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
      
      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=app --cov-report=term --cov-report=xml
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ============================================================
  # JOB 2: BUILD & DEPLOY API
  # ============================================================
  build-and-deploy-api:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to Azure Container Registry (ACR)
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Build and push API Docker image
        run: |
          echo "üî® Building API image..."
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          
          echo "üì§ Pushing to ACR..."
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          echo "‚úÖ API image pushed successfully"
      
      - name: Deploy API to Azure Container Apps
        uses: azure/CLI@v1
        with:
          inlineScript: |
            # Check if app exists
            if az containerapp show --name ${{ env.CONTAINER_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} 2>/dev/null; then
              echo "üìù Updating existing Container App..."
              az containerapp update \
                --name ${{ env.CONTAINER_APP_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
            else
              echo "üÜï Creating new Container App..."
              az containerapp create \
                --name ${{ env.CONTAINER_APP_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --environment ${{ env.CONTAINER_ENV_NAME }} \
                --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                --target-port 8000 \
                --ingress external \
                --registry-server ${{ env.ACR_NAME }}.azurecr.io \
                --registry-username ${{ secrets.ACR_USERNAME }} \
                --registry-password ${{ secrets.ACR_PASSWORD }} \
                --min-replicas 1 \
                --max-replicas 3
            fi
            echo "‚úÖ API deployment complete"
      
      - name: Verify API deployment
        run: |
          APP_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "üåê API URL: https://$APP_URL"
          echo "‚è≥ Waiting for startup (30s)..."
          sleep 30
          curl -f https://$APP_URL/health || echo "‚ö†Ô∏è Health check failed, app may still be starting"
          echo "‚úÖ API deployment verified!"

  # ============================================================
  # JOB 3: BUILD & DEPLOY STREAMLIT DASHBOARD
  # ============================================================
  build-and-deploy-streamlit:
    needs: build-and-deploy-api
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_NAME }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: Get API URL
        id: api_url
        run: |
          API_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "API_URL=https://$API_URL" >> $GITHUB_OUTPUT
      
      - name: Build and push Streamlit Docker image
        run: |
          echo "üî® Building Streamlit image..."
          docker build -f Dockerfile.streamlit \
            --build-arg API_URL=${{ steps.api_url.outputs.API_URL }} \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.STREAMLIT_IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.ACR_NAME }}.azurecr.io/${{ env.STREAMLIT_IMAGE_NAME }}:${{ github.sha }} \
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.STREAMLIT_IMAGE_NAME }}:latest
          
          echo "üì§ Pushing to ACR..."
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.STREAMLIT_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.STREAMLIT_IMAGE_NAME }}:latest
          echo "‚úÖ Streamlit image pushed successfully"
      
      - name: Deploy Streamlit to Azure Container Apps
        uses: azure/CLI@v1
        with:
          inlineScript: |
            # Check if app exists, create if not
            if az containerapp show --name ${{ env.STREAMLIT_APP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }} 2>/dev/null; then
              echo "üìù Updating existing Streamlit app..."
              az containerapp update \
                --name ${{ env.STREAMLIT_APP_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.STREAMLIT_IMAGE_NAME }}:${{ github.sha }} \
                --set-env-vars API_URL=${{ steps.api_url.outputs.API_URL }}
            else
              echo "üÜï Creating new Streamlit app..."
              az containerapp create \
                --name ${{ env.STREAMLIT_APP_NAME }} \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --environment ${{ env.CONTAINER_ENV_NAME }} \
                --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.STREAMLIT_IMAGE_NAME }}:${{ github.sha }} \
                --target-port 8501 \
                --ingress external \
                --registry-server ${{ env.ACR_NAME }}.azurecr.io \
                --registry-username ${{ secrets.ACR_USERNAME }} \
                --registry-password ${{ secrets.ACR_PASSWORD }} \
                --env-vars API_URL=${{ steps.api_url.outputs.API_URL }} \
                --min-replicas 1 \
                --max-replicas 3
            fi
            echo "‚úÖ Streamlit deployment command sent"
      
      - name: Get deployment URLs
        run: |
          API_URL=$(az containerapp show \
            --name ${{ env.CONTAINER_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          
          STREAMLIT_URL=$(az containerapp show \
            --name ${{ env.STREAMLIT_APP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query properties.configuration.ingress.fqdn -o tsv)
          
          echo "=========================================="
          echo "‚úÖ DEPLOYMENT COMPLETE"
          echo "=========================================="
          echo "üîå API:       https://$API_URL"
          echo "üìä Dashboard: https://$STREAMLIT_URL"
          echo "üìö API Docs:  https://$API_URL/docs"
          echo "=========================================="

  # ============================================================
  # JOB 4: DRIFT MONITORING (scheduled)
  # ============================================================
  drift-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run drift detection
        run: |
          python -c "
          from app.drift_detect import DriftDetector
          import pandas as pd
          import json
          
          detector = DriftDetector(threshold=0.05)
          
          # Load data
          ref_data = pd.read_csv('data/bank_churn.csv')
          
          # Check if production data exists
          try:
              prod_data = pd.read_csv('data/production_data.csv')
              results = detector.detect_all(ref_data, prod_data)
              report = detector.generate_report(results)
              
              print('=' * 50)
              print('DRIFT DETECTION REPORT')
              print('=' * 50)
              print(f\"Features analyzed: {report['summary']['total_features']}\")
              print(f\"Features with drift: {report['summary']['drifted_features_count']}\")
              print(f\"Risk level: {report['summary']['risk_level']}\")
              print(f\"Recommendation: {report['summary']['recommendation']}\")
              print('=' * 50)
          except FileNotFoundError:
              print('No production data found for drift detection')
          "